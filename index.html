
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presales Compass</title>
    <link rel="icon" href="data:,">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
          --primary: #111827;
          --primary-hover: #000000;
          --primary-light: #F3F4F6;
          --text-main: #111827;
          --text-secondary: #4B5563;
          --text-muted: #9CA3AF;
          --bg-body: #F9FAFB;
          --bg-card: #FFFFFF;
          --bg-sidebar: #FFFFFF;
          --border: #E5E7EB;
          --radius-lg: 16px;
          --radius-md: 12px;
          --radius-sm: 8px;
          --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); -webkit-font-smoothing: antialiased; min-height: 100vh; }

        .app-container { display: flex; width: 100%; max-width: 1120px; margin: 40px auto; padding: 0 24px; gap: 32px; align-items: flex-start; }

        #view-onboarding { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-body); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .onboarding-card { background: var(--bg-card); padding: 48px; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); width: 100%; max-width: 440px; text-align: center; border: 1px solid var(--border); }
        .onboarding-logo { width: 64px; height: 64px; background: var(--primary); color: white; border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; }
        .onboarding-input { width: 100%; padding: 14px 16px; border-radius: var(--radius-md); border: 1px solid var(--border); font-size: 16px; margin-bottom: 20px; outline: none; }
        .btn-primary { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: var(--radius-md); font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-primary:disabled { background: var(--text-muted); cursor: not-allowed; }

        .sync-status { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-muted); margin-top: 12px; }
        .sync-dot { width: 6px; height: 6px; border-radius: 50%; background: #10B981; }
        .sync-dot.syncing { background: #3B82F6; animation: pulse 1.5s infinite; }
        .sync-dot.offline { background: #F59E0B; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .sidebar { width: 260px; flex-shrink: 0; background: var(--bg-sidebar); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; position: sticky; top: 40px; height: fit-content; z-index: 50; }
        .sidebar-header { padding: 24px 20px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); }
        .logo-box { width: 36px; height: 36px; background: var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; }
        .app-title { font-weight: 700; font-size: 16px; letter-spacing: -0.02em; }
        .sidebar-menu { padding: 20px 12px; }
        .sidebar-footer { padding: 20px 12px; border-top: 1px solid var(--border); margin-top: auto; }
        .user-profile { display: flex; align-items: center; gap: 12px; padding: 8px 12px; }
        .avatar-circle { width: 32px; height: 32px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; }
        
        .menu-label { font-size: 11px; font-weight: 600; color: var(--text-muted); padding: 0 12px; margin-bottom: 12px; text-transform: uppercase; }
        .menu-item { display: flex; align-items: center; width: 100%; padding: 10px 12px; margin-bottom: 4px; border: none; background: transparent; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-secondary); font-size: 14px; font-weight: 500; gap: 12px; transition: all 0.2s; position: relative; text-align: left; }
        .menu-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
        .active-indicator { position: absolute; right: 12px; width: 6px; height: 6px; border-radius: 50%; background: var(--primary); display: none; }
        .menu-item.active .active-indicator { display: block; }

        .main { flex: 1; width: 100%; min-width: 0; }
        .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
        h1 { font-size: 28px; font-weight: 700; margin: 0 0 8px 0; letter-spacing: -0.03em; }
        .page-subtitle { font-size: 16px; color: var(--text-secondary); margin: 0; }

        .card-premium { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); margin-bottom: 24px; overflow: hidden; }
        .score-overview-card { display: flex; padding: 32px; align-items: center; gap: 40px; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; border: 8px solid #DBEAFE; display: flex; flex-direction: column; align-items: center; justify-content: center; transform: rotate(45deg); background: #EFF6FF; position: relative; }
        .score-circle > * { transform: rotate(-45deg); }
        .score-number { font-size: 32px; font-weight: 800; line-height: 1; }
        .score-unit { font-size: 12px; color: var(--text-muted); font-weight: 600; margin-top: 4px; }
        .progress-bar-track { height: 8px; background: #E5E7EB; border-radius: 4px; margin-top: 8px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

        .checklist-row { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border); gap: 24px; }
        .category-title { background: #F9FAFB; padding: 16px 24px; margin: 0; font-size: 16px; border-bottom: 1px solid var(--border); font-weight: 700; }

        .slider-container { width: 220px; flex-shrink: 0; }
        .slider-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .slider-num { font-size: 12px; color: #D1D5DB; cursor: pointer; width: 20px; text-align: center; font-weight: 600; }
        .slider-num.active { color: var(--primary); transform: scale(1.2); }
        .slider-track-wrapper { position: relative; height: 24px; display: flex; align-items: center; }
        .track-bg { position: absolute; left: 0; right: 0; height: 4px; background: #E5E7EB; border-radius: 2px; }
        .track-fill { position: absolute; left: 0; height: 4px; background: var(--primary); border-radius: 2px; }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 24px; background: transparent; position: relative; z-index: 2; cursor: pointer; margin: 0; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #fff; border: 2px solid #D1D5DB; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #F9FAFB; text-align: left; padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 12px; text-transform: uppercase; color: var(--text-secondary); }
        td { padding: 16px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .domain-cell { background: white; border-right: 1px solid var(--border); text-align: center; vertical-align: top; }
        .gap-badge { padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: 700; }
        .gap-high { background: var(--primary); color: white; }
        .gap-low { background: #F3F4F6; color: #9CA3AF; }

        .priority-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 24px; }
        .priority-card { padding: 24px; border-left: 4px solid var(--primary); background: #fff; }

        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .btn-reset { background: white; border: 1px solid var(--border); padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-reset:hover { background: #f9fafb; border-color: #d1d5db; }

        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:2000; padding: 40px; text-align: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom:16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .report-section-title { font-size: 18px; font-weight: 700; margin: 24px 0 16px; padding-bottom: 8px; border-bottom: 2px solid var(--primary); color: var(--primary); }
        .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .report-summary-box { background: #F3F4F6; padding: 20px; border-radius: 12px; text-align: center; }
        .report-summary-value { font-size: 28px; font-weight: 800; display: block; }
        .report-summary-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div id="loading-spinner" class="spinner"></div>
        <div id="loading-content">
            <p style="font-weight:600; color:var(--text-secondary)">엔진을 예열하고 있습니다...</p>
        </div>
    </div>

    <div id="view-onboarding" class="hidden">
        <div class="onboarding-card">
            <div class="onboarding-logo">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>
            </div>
            <h1 style="font-size: 24px; margin-bottom: 8px;">Presales Compass</h1>
            <p style="color: var(--text-secondary); margin-bottom: 32px; font-size: 15px;">나침반을 사용하기 위해 성함을 입력하세요.<br><small>(기존 사용자는 이전 데이터가 자동 로드됩니다)</small></p>
            <input type="text" id="user-name-input" class="onboarding-input" placeholder="성함 입력" maxlength="20" onkeyup="if(event.key === 'Enter') app.submitName()">
            <button id="btn-onboarding-start" class="btn-primary" onclick="app.submitName()">나침반 시작하기</button>
        </div>
    </div>

    <div id="app" class="app-container hidden">
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo-box">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>
                </div>
                <span class="app-title">Presales Compass</span>
            </div>
            <div class="sidebar-menu">
                <div class="menu-label">MENU</div>
                <button id="menu-suitability" class="menu-item active" onclick="app.navigate('suitability')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                    업무 적합성 체크리스트
                    <div class="active-indicator"></div>
                </button>
                <button id="menu-competency" class="menu-item" onclick="app.navigate('competency')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                    역량 평가 및 학습
                    <div class="active-indicator"></div>
                </button>
                <button id="menu-report" class="menu-item" onclick="app.navigate('report')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    종합 결과 보고서
                    <div class="active-indicator"></div>
                </button>
            </div>
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div id="user-avatar" class="avatar-circle">?</div>
                    <div>
                        <div id="user-name-display" style="font-weight: 600; font-size: 14px;">사용자</div>
                        <div style="font-size: 11px; color: var(--text-muted); cursor: pointer;" onclick="app.logout()">로그아웃 (계정 변경)</div>
                    </div>
                </div>
                <div class="sync-status">
                    <div id="sync-dot" class="sync-dot"></div>
                    <span id="sync-text">클라우드 동기화 됨</span>
                </div>
            </div>
        </nav>

        <main class="main">
            <div id="view-suitability">
                <div class="page-header">
                    <div>
                        <h1>프리세일즈 업무 적합성 체크리스트</h1>
                        <p class="page-subtitle"><span class="welcome-name">사용자</span>님, 본인의 성향과 역량이 직무에 얼마나 부합하는지 진단해보세요.</p>
                    </div>
                    <button class="btn-reset" onclick="app.resetSuitability()">평가 초기화</button>
                </div>
                <div class="card-premium score-overview-card">
                    <div class="score-circle">
                        <span id="suitability-total-score" class="score-number">0</span>
                        <span class="score-unit">점</span>
                    </div>
                    <div class="score-details" style="flex:1">
                        <div style="font-size:14px; font-weight:600; color:var(--text-secondary); margin-bottom:12px; text-transform:uppercase;">현재 적합도 점수</div>
                        <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:8px;">
                            <span id="suitability-progress-text">진행률 (0/11)</span>
                            <span id="suitability-progress-percent">0%</span>
                        </div>
                        <div class="progress-bar-track">
                            <div id="suitability-progress-bar" class="progress-bar-fill"></div>
                        </div>
                    </div>
                </div>
                <div id="checklist-container"></div>
            </div>

            <div id="view-competency" class="hidden">
                <div class="page-header">
                    <div>
                        <h1>역량 평가 및 학습 우선순위</h1>
                        <p class="page-subtitle"><span class="welcome-name">사용자</span>님의 현재 역량을 진단하고 학습 우선순위를 도출합니다.</p>
                    </div>
                    <button class="btn-reset" onclick="app.resetCompetency()">평가 초기화</button>
                </div>
                <div class="card-premium">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th class="text-center" style="width:13%">영역</th>
                                    <th style="width:46%">역량 상세</th>
                                    <th class="text-center" style="width:8%">중요도</th>
                                    <th class="text-center" style="width:25%">내 역량 (1~5)</th>
                                    <th class="text-center" style="width:8%">GAP</th>
                                </tr>
                            </thead>
                            <tbody id="competency-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="priority-section" class="hidden">
                    <h3 style="font-size:20px; margin-top:40px;">학습 우선순위 TOP 3</h3>
                    <div id="priority-list" class="priority-grid"></div>
                </div>
            </div>

            <div id="view-report" class="hidden">
                <div class="page-header">
                    <h1>종합 결과 보고서</h1>
                    <button class="btn-reset" onclick="app.downloadPDF()">PDF 저장</button>
                </div>
                <div id="report-content"></div>
            </div>
        </main>
    </div>

    <!-- Firebase Logic (JS Module) -->
    <script type="module" src="index.js"></script>

    <script>
    // Constants (Data remains the same)
    const SUITABILITY_DATA = [
        { id: "tech", title: "1. 기술 역량", items: [{ id: "t1", text: "새로운 기술을 배우고 문제를 해결하는 데 흥미를 느낀다." }, { id: "t2", text: "최신 기술 및 업계 동향을 지속적으로 학습하고 있다." }, { id: "t3", text: "RFP, 제안서, PoC 보고서 등의 문서를 작성하는 것이 익숙하다." }] },
        { id: "biz", title: "2. 비즈니스 및 고객 대응", items: [{ id: "b1", text: "고객이 원하는 가치를 이해하고, 비즈니스적 관점에서 솔루션을 고민할 수 있다." }, { id: "b2", text: "기업의 성장을 위해 좋은 제품을 만드는 것만큼 판매가 중요하다고 생각한다." }, { id: "b3", text: "고객이 명확하게 정의하지 않은 요구사항을 파악하고, 최적의 솔루션을 제안할 수 있다." }, { id: "b4", text: "고객과 신뢰를 구축하며, 협업을 원활하게 진행할 수 있다." }] },
        { id: "comm", title: "3. 커뮤니케이션 및 협업", items: [{ id: "c1", text: "기술적 내용을 고객이 이해하기 쉽게 설명할 수 있다." }, { id: "c2", text: "영업, 개발, 컨설팅 등 다양한 팀과 협업한 경험이 있다." }] },
        { id: "prob", title: "4. 문제 해결 및 멀티태스킹", items: [{ id: "p1", text: "복잡한 문제를 논리적으로 분석하고 해결책을 찾는 능력이 있다." }, { id: "p2", text: "여러 개의 프로젝트나 고객을 동시에 관리하고 진행할 수 있다." }] }
    ];

    const COMPETENCY_DATA = [
        { id: "d1", name: "1. 기술적 지식", weight: 5, items: [{ id: "c1_1", text: "제품 또는 서비스에 대한 전반적인 이해도", importance: 5 }, { id: "c1_2", text: "제품 또는 서비스의 기능과 특징에 대한 이해", importance: 5 }, { id: "c1_3", text: "경쟁 제품과의 비교 분석에 대한 이해", importance: 4 }, { id: "c1_4", text: "제품 또는 서비스의 가치와 이점에 대한 이해", importance: 5 }] },
        { id: "d2", name: "2. 커뮤니케이션 기술", weight: 5, items: [{ id: "c2_1", text: "효과적인 커뮤니케이션 기술", importance: 5 }, { id: "c2_2", text: "명확하고 구조화된 프레젠테이션 기술", importance: 4 }, { id: "c2_3", text: "청중을 이해하고 이에 맞는 커뮤니케이션", importance: 4 }, { id: "c2_4", text: "비기술적인 고객 용어를 사용하여 설명하는 능력", importance: 3 }] },
        { id: "d3", name: "3. 분석 및 문제 해결 능력", weight: 4.5, items: [{ id: "c3_1", text: "고객의 요구 사항을 분석하고 이해", importance: 5 }, { id: "c3_2", text: "복잡한 문제를 해결하는 능력", importance: 4 }, { id: "c3_3", text: "고객의 비즈니스 도전과제를 파악하는 능력", importance: 4 }, { id: "c3_4", text: "제품 또는 서비스를 적용하여 해결책을 제시하는 능력", importance: 4 }] },
        { id: "d4", name: "4. 고객 관계 구축", weight: 4, items: [{ id: "c4_1", text: "고객과의 강력한 관계 형성", importance: 5 }, { id: "c4_2", text: "신뢰와 신뢰성을 구축하는 능력", importance: 5 }, { id: "c4_3", text: "고객의 욕구와 필요를 이해하는 능력", importance: 4 }, { id: "c4_4", text: "고객과의 소통을 통한 관계 유지", importance: 3 }] },
        { id: "d5", name: "5. 기술 전략 개발", weight: 4, items: [{ id: "c5_1", text: "비즈니스 환경과 산업 동향에 대한 이해", importance: 5 }, { id: "c5_2", text: "고객의 비즈니스 모델과 요구사항에 대한 이해", importance: 4 }, { id: "c5_3", text: "기술 전략을 개발하고 실행하는 능력", importance: 5 }, { id: "c5_4", text: "고객이 가치를 창출할 수 있는 방법 제시", importance: 4 }] }
    ];

    const app = {
        state: {
            userName: '',
            view: 'suitability',
            suitabilityScores: {},
            competencyScores: {},
            radarChart: null,
            isSyncing: false
        },

        init: async function() {
            // 접속 시 항상 온보딩(로그인) 화면 노출
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('view-onboarding').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
            document.getElementById('user-name-input').focus();
        },

        setSyncing: function(syncing, error = false) {
            this.state.isSyncing = syncing;
            const dot = document.getElementById('sync-dot');
            const text = document.getElementById('sync-text');
            if (error) {
                dot.className = 'sync-dot offline';
                text.innerText = "오프라인 모드 (로컬 저장)";
                return;
            }
            if (syncing) {
                dot.className = 'sync-dot syncing';
                text.innerText = "데이터 불러오는 중...";
            } else {
                dot.className = 'sync-dot';
                text.innerText = "클라우드 동기화 됨";
            }
        },

        submitName: async function() {
            const input = document.getElementById('user-name-input');
            const btn = document.getElementById('btn-onboarding-start');
            const name = input.value.trim();
            if (!name) return;

            btn.disabled = true;
            btn.innerText = "데이터 확인 중...";
            this.setSyncing(true);

            try {
                // Firebase에서 해당 이름의 데이터 로드 시도
                const userData = await window.firebaseDB.loadUserData(name);
                
                this.state.userName = name;
                if (userData) {
                    // 기존 데이터가 있으면 복구
                    this.state.suitabilityScores = userData.suitabilityScores || {};
                    this.state.competencyScores = userData.competencyScores || {};
                } else {
                    // 새 사용자면 초기화
                    this.state.suitabilityScores = {};
                    this.state.competencyScores = {};
                }

                this.updateUserUI();
                this.renderSuitabilityChecklist();
                this.updateSuitabilityStats();
                this.renderCompetencyTable();
                this.updateCompetencyAnalysis();

                document.getElementById('view-onboarding').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                this.navigate('suitability');
                this.setSyncing(false);

            } catch (e) {
                console.error("Login failed:", e);
                this.setSyncing(false, true);
                alert("데이터를 불러오는 중 오류가 발생했습니다. 오프라인 모드로 시작합니다.");
                
                this.state.userName = name;
                document.getElementById('view-onboarding').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerText = "나침반 시작하기";
            }
        },

        saveData: async function() {
            if (!this.state.userName) return;

            const localData = {
                userName: this.state.userName,
                suitabilityScores: this.state.suitabilityScores,
                competencyScores: this.state.competencyScores,
                updatedAt: new Date().toISOString()
            };
            
            if (window.firebaseDB) {
                this.setSyncing(true);
                try {
                    await window.firebaseDB.saveUserData(this.state.userName, localData);
                    this.setSyncing(false);
                } catch (e) {
                    this.setSyncing(false, true);
                }
            }
        },

        updateUserUI: function() {
            const avatar = document.getElementById('user-avatar');
            const display = document.getElementById('user-name-display');
            const welcomes = document.querySelectorAll('.welcome-name');
            if (this.state.userName) {
                avatar.innerText = this.state.userName.charAt(0).toUpperCase();
                display.innerText = `${this.state.userName}님`;
                welcomes.forEach(el => el.innerText = this.state.userName);
            }
        },

        logout: function() {
            if (confirm("로그아웃 하시겠습니까? 입력한 데이터는 이름 기반으로 저장되어 다시 로그인 시 불러올 수 있습니다.")) {
                location.reload(); // 가장 깔끔하게 초기 상태로 회항
            }
        },

        navigate: function(viewName) {
            this.state.view = viewName;
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            const menuBtn = document.getElementById(`menu-${viewName}`);
            if (menuBtn) menuBtn.classList.add('active');
            document.getElementById('view-suitability').classList.add('hidden');
            document.getElementById('view-competency').classList.add('hidden');
            document.getElementById('view-report').classList.add('hidden');
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            if (viewName === 'report') this.renderReport();
        },

        // --- UI Rendering Helpers (Existing logic below remains same for functionality) ---

        generateSliderHTML: function(id, score, isSelected, type) {
            const changeHandler = type === 'suitability' ? `app.setSuitabilityScore` : `app.setCompetencyScore`;
            return `
                <div class="slider-container">
                    <div class="slider-header" id="header-${id}">
                        ${[1,2,3,4,5].map(n => `<div class="slider-num ${score === n ? 'active' : ''}" onclick="${changeHandler}('${id}', ${n})">${n}</div>`).join('')}
                    </div>
                    <div class="slider-track-wrapper">
                        <div class="track-bg"></div>
                        <div class="track-fill" id="fill-${id}" style="width: ${((score-1)/4)*100}%; opacity:${isSelected ? 1 : 0.3}"></div>
                        <input type="range" min="1" max="5" step="1" value="${score}" id="input-${id}" 
                            oninput="app.handleSliderInput('${id}', this.value)" 
                            onchange="${changeHandler}('${id}', parseInt(this.value))">
                    </div>
                </div>
            `;
        },

        handleSliderInput: function(id, val) {
            const score = parseInt(val);
            const fill = document.getElementById(`fill-${id}`);
            if (fill) {
                fill.style.width = `${((score-1)/4)*100}%`;
                fill.style.opacity = '1';
            }
            const header = document.getElementById(`header-${id}`);
            if (header) {
                Array.from(header.children).forEach((c, i) => c.classList.toggle('active', i+1 === score));
            }
        },

        renderSuitabilityChecklist: function() {
            const container = document.getElementById('checklist-container');
            let html = '';
            SUITABILITY_DATA.forEach(cat => {
                html += `<div class="card-premium category-card"><h2 class="category-title">${cat.title}</h2><div>`;
                cat.items.forEach(item => {
                    const score = this.state.suitabilityScores[item.id] || 3;
                    const isSelected = this.state.suitabilityScores.hasOwnProperty(item.id);
                    html += `<div class="checklist-row"><div>${item.text}</div>${this.generateSliderHTML(item.id, score, isSelected, 'suitability')}</div>`;
                });
                html += `</div></div>`;
            });
            container.innerHTML = html;
        },

        setSuitabilityScore: async function(id, score) {
            this.state.suitabilityScores[id] = score;
            this.handleSliderInput(id, score);
            this.updateSuitabilityStats();
            await this.saveData();
        },

        updateSuitabilityStats: function() {
            const totalItems = 11;
            const values = Object.values(this.state.suitabilityScores);
            const filledCount = values.length;
            const sum = values.reduce((a, b) => a + b, 0);
            const scorePercent = totalItems === 0 ? 0 : Math.round((sum / (totalItems * 5)) * 100);
            const progressPercent = Math.round((filledCount / totalItems) * 100);
            document.getElementById('suitability-total-score').innerText = scorePercent;
            document.getElementById('suitability-progress-text').innerText = `진행률 (${filledCount}/${totalItems})`;
            document.getElementById('suitability-progress-percent').innerText = `${progressPercent}%`;
            document.getElementById('suitability-progress-bar').style.width = `${progressPercent}%`;
        },

        resetSuitability: async function() {
            if(confirm("체크리스트를 초기화하시겠습니까?")) {
                this.state.suitabilityScores = {};
                this.renderSuitabilityChecklist();
                this.updateSuitabilityStats();
                await this.saveData();
            }
        },

        renderCompetencyTable: function() {
            const tbody = document.getElementById('competency-table-body');
            let html = '';
            COMPETENCY_DATA.forEach(dom => {
                dom.items.forEach((item, idx) => {
                    const score = this.state.competencyScores[item.id] || 3;
                    const isSelected = this.state.competencyScores.hasOwnProperty(item.id);
                    const gap = isSelected ? (dom.weight * item.importance * (item.importance - score)) : null;
                    html += `<tr>`;
                    if (idx === 0) html += `<td rowspan="${dom.items.length}" class="domain-cell"><strong>${dom.name}</strong><br><small>가중치 ${dom.weight}</small></td>`;
                    html += `<td>${item.text}</td><td class="text-center">${item.importance}</td><td class="text-center">${this.generateSliderHTML(item.id, score, isSelected, 'competency')}</td><td class="text-center">${gap !== null ? `<span class="gap-badge ${gap>0?'gap-high':'gap-low'}">${gap.toFixed(0)}</span>` : '-'}</td></tr>`;
                });
            });
            tbody.innerHTML = html;
        },

        setCompetencyScore: async function(id, score) {
            this.state.competencyScores[id] = score;
            this.handleSliderInput(id, score);
            this.updateCompetencyAnalysis();
            this.renderCompetencyTable();
            await this.saveData();
        },

        updateCompetencyAnalysis: function() {
            const prios = this.getPriorityItems();
            const section = document.getElementById('priority-section');
            const list = document.getElementById('priority-list');
            if(prios.length > 0) {
                section.classList.remove('hidden');
                list.innerHTML = prios.map((p, idx) => `
                    <div class="card-premium priority-card">
                        <div style="font-size:11px; font-weight:800; color:var(--primary); margin-bottom:4px;">RANK ${idx+1}</div>
                        <div style="font-weight:600; font-size:14px; margin-bottom:8px; line-height:1.4;">${p.text}</div>
                        <div style="font-size:12px; color:var(--text-muted);">${p.domain}</div>
                    </div>`).join('');
            } else section.classList.add('hidden');
        },

        getPriorityItems: function() {
            const prios = [];
            COMPETENCY_DATA.forEach(d => d.items.forEach(i => {
                const s = this.state.competencyScores[i.id];
                if(s) {
                    const g = d.weight * i.importance * (i.importance - s);
                    if(g > 0) prios.push({ domain: d.name, text: i.text, gap: g });
                }
            }));
            prios.sort((a,b) => b.gap - a.gap);
            return prios.slice(0,3);
        },

        resetCompetency: async function() {
            if(confirm("역량 평가를 초기화하시겠습니까?")) {
                this.state.competencyScores = {};
                this.renderCompetencyTable();
                this.updateCompetencyAnalysis();
                await this.saveData();
            }
        },

        renderReport: function() {
            const container = document.getElementById('report-content');
            container.innerHTML = `<div class="card-premium" style="padding:40px; text-align:center;">리포트를 생성 중입니다...</div>`;
            
            const suitabilityValues = Object.values(this.state.suitabilityScores);
            const totalSuitabilityItems = 11;
            const suitabilitySum = suitabilityValues.reduce((a,b) => a+b, 0);
            const suitabilityScore = totalSuitabilityItems === 0 ? 0 : Math.round((suitabilitySum / (totalSuitabilityItems * 5)) * 100);

            const suitabilityCategories = SUITABILITY_DATA.map(cat => {
                let sum = 0;
                let count = 0;
                cat.items.forEach(i => {
                    if (this.state.suitabilityScores[i.id]) {
                        sum += this.state.suitabilityScores[i.id];
                        count++;
                    }
                });
                return { 
                    title: cat.title.split('. ')[1] || cat.title, 
                    score: count === 0 ? 0 : Math.round((sum / (cat.items.length * 5)) * 100)
                };
            });

            const priorityItems = this.getPriorityItems();

            setTimeout(() => {
                container.innerHTML = `
                    <div class="card-premium" style="padding:48px;">
                        <div style="text-align:center; margin-bottom:40px;">
                            <h2 style="margin:0 0 8px 0; font-size:28px;">프리세일즈 역량 진단 리포트</h2>
                            <p style="color:var(--text-secondary); margin:0;">대상자: ${this.state.userName}님 | 진단일: ${new Date().toLocaleDateString()}</p>
                        </div>

                        <div class="report-section-title">1. 업무 적합성 진단 결과</div>
                        <div class="report-grid" style="margin-bottom:32px;">
                            <div class="report-summary-box">
                                <span class="report-summary-value">${suitabilityScore}점</span>
                                <span class="report-summary-label">종합 업무 적합도</span>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:8px;">
                                ${suitabilityCategories.map(cat => `
                                    <div>
                                        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
                                            <span>${cat.title}</span>
                                            <span style="font-weight:700;">${cat.score}%</span>
                                        </div>
                                        <div style="height:6px; background:#E5E7EB; border-radius:3px; overflow:hidden;">
                                            <div style="width:${cat.score}%; height:100%; background:var(--primary);"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="report-section-title">2. 역량 레이더 분석 (100점 환산)</div>
                        <div style="max-width:520px; margin: 0 auto 40px; background: white; padding: 20px; border-radius: 12px;">
                            <canvas id="reportChart"></canvas>
                        </div>

                        <div class="report-section-title">3. 중점 학습 우선순위 (Top 3)</div>
                        ${priorityItems.length > 0 ? `
                            <div class="priority-grid">
                                ${priorityItems.map((p, idx) => `
                                    <div class="card-premium priority-card" style="box-shadow:none; border:1px solid var(--border);">
                                        <div style="font-size:11px; font-weight:800; color:var(--primary); margin-bottom:4px;">RANK ${idx+1}</div>
                                        <div style="font-weight:600; font-size:14px; margin-bottom:8px; line-height:1.4;">${p.text}</div>
                                        <div style="font-size:12px; color:var(--text-muted);">${p.domain}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="text-align:center; color:var(--text-muted);">평가 데이터가 충분하지 않거나 보완할 역량이 없습니다.</p>'}
                    </div>
                `;
                const ctx = document.getElementById('reportChart');
                
                const radarData = COMPETENCY_DATA.map(d => {
                    let s = 0;
                    let count = 0;
                    d.items.forEach(i => {
                        if(this.state.competencyScores[i.id]) {
                            s += this.state.competencyScores[i.id];
                            count++;
                        }
                    });
                    return count === 0 ? 0 : Math.round((s / (d.items.length * 5)) * 100);
                });

                new Chart(ctx, {
                    type: 'radar',
                    plugins: [ChartDataLabels],
                    data: {
                        labels: COMPETENCY_DATA.map(d => d.name.split('. ')[1] || d.name),
                        datasets: [{
                            label: '역량 점수',
                            data: radarData,
                            borderColor: '#111827',
                            backgroundColor: 'rgba(17, 24, 39, 0.1)',
                            borderWidth: 2,
                            pointBackgroundColor: '#111827',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#111827',
                            pointRadius: 4
                        }]
                    },
                    options: { 
                        layout: { padding: { top: 20, bottom: 20 } },
                        scales: { 
                            r: { 
                                suggestedMin: 0, 
                                suggestedMax: 110,
                                ticks: { stepSize: 20, display: false },
                                grid: { color: '#E5E7EB' },
                                angleLines: { color: '#E5E7EB' },
                                pointLabels: { 
                                    font: { size: 12, weight: '700' },
                                    color: '#4B5563',
                                    padding: 15
                                }
                            } 
                        },
                        plugins: { 
                            legend: { display: false },
                            datalabels: {
                                backgroundColor: 'rgba(17, 24, 39, 0.85)',
                                borderRadius: 4,
                                color: '#fff',
                                font: { size: 10, weight: '800' },
                                padding: { top: 4, bottom: 4, left: 6, right: 6 },
                                anchor: 'end',
                                align: 'top',
                                offset: 8,
                                formatter: (value) => value > 0 ? value : '',
                                display: (context) => context.dataset.data[context.dataIndex] > 0
                            }
                        }
                    }
                });
            }, 500);
        },

        downloadPDF: function() {
            const element = document.getElementById('report-content');
            const opt = {
                margin: 10,
                filename: `Presales_Compass_${this.state.userName}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }
    };

    window.app = app;
    document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
