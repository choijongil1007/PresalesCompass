
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presales Compass Admin</title>
    <link rel="icon" href="data:,">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
          --primary: #111827;
          --primary-hover: #000000;
          --primary-light: #F3F4F6;
          --text-main: #111827;
          --text-secondary: #4B5563;
          --text-muted: #9CA3AF;
          --bg-body: #F9FAFB;
          --bg-card: #FFFFFF;
          --bg-sidebar: #FFFFFF;
          --border: #E5E7EB;
          --radius-lg: 16px;
          --radius-md: 12px;
          --radius-sm: 8px;
          --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); -webkit-font-smoothing: antialiased; min-height: 100vh; }

        .app-container { display: flex; width: 100%; max-width: 1120px; margin: 40px auto; padding: 0 24px; gap: 32px; align-items: flex-start; }
        .app-container.admin-mode { max-width: 1400px; }

        #view-onboarding { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-body); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .onboarding-card { background: var(--bg-card); padding: 48px; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); width: 100%; max-width: 440px; text-align: center; border: 1px solid var(--border); }
        .onboarding-logo { width: 64px; height: 64px; background: var(--primary); color: white; border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; }
        .onboarding-input { width: 100%; padding: 14px 16px; border-radius: var(--radius-md); border: 1px solid var(--border); font-size: 16px; margin-bottom: 20px; outline: none; text-align: center; }
        .btn-primary { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: var(--radius-md); font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-primary:disabled { background: var(--text-muted); cursor: not-allowed; }

        .sidebar { width: 260px; flex-shrink: 0; background: var(--bg-sidebar); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; position: sticky; top: 40px; height: fit-content; z-index: 50; }
        .main { flex: 1; width: 100%; min-width: 0; }
        
        /* Admin Dashboard Styles */
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 24px; margin-top: 24px; }
        .admin-user-card { background: white; border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); transition: transform 0.2s, box-shadow 0.2s; }
        .admin-user-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .admin-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
        .admin-user-name { font-size: 18px; font-weight: 700; margin: 0; }
        .admin-update-time { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        
        .admin-score-badge { padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 800; background: #DBEAFE; color: #1E40AF; }
        
        .admin-section-label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin: 16px 0 8px; letter-spacing: 0.05em; }
        .admin-comp-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
        .admin-comp-bar { height: 4px; background: #F3F4F6; border-radius: 2px; overflow: hidden; margin-bottom: 10px; }
        .admin-comp-fill { height: 100%; background: var(--primary); border-radius: 2px; }

        .admin-priority-tag { display: inline-block; padding: 4px 8px; background: #F9FAFB; border: 1px solid var(--border); border-radius: 6px; font-size: 11px; font-weight: 500; margin: 0 4px 4px 0; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Existing View Styles */
        .card-premium { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); margin-bottom: 24px; overflow: hidden; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; border: 8px solid #DBEAFE; display: flex; flex-direction: column; align-items: center; justify-content: center; transform: rotate(45deg); background: #EFF6FF; position: relative; }
        .score-circle > * { transform: rotate(-45deg); }
        .score-number { font-size: 32px; font-weight: 800; line-height: 1; }
        .progress-bar-track { height: 8px; background: #E5E7EB; border-radius: 4px; margin-top: 8px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        .hidden { display: none !important; }
        .btn-reset { background: white; border: 1px solid var(--border); padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        
        .sync-status { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-muted); margin-top: 12px; }
        .sync-dot { width: 6px; height: 6px; border-radius: 50%; background: #10B981; }

        /* Sidebar and Layout */
        .sidebar-header { padding: 24px 20px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); }
        .logo-box { width: 36px; height: 36px; background: var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; }
        .sidebar-menu { padding: 20px 12px; }
        .menu-item { display: flex; align-items: center; width: 100%; padding: 10px 12px; margin-bottom: 4px; border: none; background: transparent; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-secondary); font-size: 14px; font-weight: 500; gap: 12px; transition: all 0.2s; text-align: left; }
        .menu-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
        .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
    </style>
</head>
<body>
    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
    </div>

    <div id="view-onboarding">
        <div class="onboarding-card">
            <div class="onboarding-logo">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>
            </div>
            <h1 style="font-size: 24px; margin-bottom: 8px;">Presales Compass</h1>
            <p style="color: var(--text-secondary); margin-bottom: 32px; font-size: 15px;">나침반을 사용하기 위해 성함을 입력하세요.<br><small>(관리자 로그인은 '관리자' 입력)</small></p>
            <input type="text" id="user-name-input" class="onboarding-input" placeholder="성함 입력" maxlength="20" onkeyup="if(event.key === 'Enter') app.submitName()">
            <button id="btn-onboarding-start" class="btn-primary" onclick="app.submitName()">나침반 시작하기</button>
        </div>
    </div>

    <div id="app" class="app-container hidden">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="logo-box">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>
                </div>
                <span class="app-title">Presales Compass</span>
            </div>
            <div class="sidebar-menu">
                <button id="menu-suitability" class="menu-item active" onclick="app.navigate('suitability')">업무 적합성</button>
                <button id="menu-competency" class="menu-item" onclick="app.navigate('competency')">역량 평가</button>
                <button id="menu-report" class="menu-item" onclick="app.navigate('report')">결과 보고서</button>
            </div>
            <div style="padding: 20px; border-top:1px solid var(--border); margin-top:auto;">
                <div id="user-name-display" style="font-weight: 600; font-size: 14px; margin-bottom:8px;">사용자</div>
                <div style="font-size: 11px; color: var(--text-muted); cursor: pointer;" onclick="location.reload()">로그아웃</div>
                <div class="sync-status">
                    <div class="sync-dot"></div>
                    <span id="sync-text">동기화 됨</span>
                </div>
            </div>
        </nav>

        <main class="main">
            <!-- 사용자용 뷰 -->
            <div id="view-suitability">
                <div class="page-header">
                    <h1>업무 적합성 체크리스트</h1>
                    <button class="btn-reset" onclick="app.resetSuitability()">초기화</button>
                </div>
                <!-- ... 기존 코드 구조 ... -->
                <div id="checklist-container"></div>
            </div>

            <div id="view-competency" class="hidden">
                <div class="page-header"><h1>역량 평가 및 학습</h1><button class="btn-reset" onclick="app.resetCompetency()">초기화</button></div>
                <div id="competency-table-container" class="card-premium"></div>
            </div>

            <div id="view-report" class="hidden">
                <div class="page-header"><h1>결과 보고서</h1><button class="btn-reset" onclick="app.downloadPDF()">PDF 저장</button></div>
                <div id="report-content"></div>
            </div>

            <!-- 관리자용 전용 뷰 -->
            <div id="view-admin" class="hidden">
                <div class="page-header">
                    <div>
                        <h1 style="font-size: 32px;">사용자 관리 대시보드</h1>
                        <p style="color:var(--text-secondary)">저장된 모든 사용자의 프리세일즈 역량 데이터를 실시간으로 모니터링합니다.</p>
                    </div>
                    <button class="btn-reset" onclick="location.reload()">관리자 로그아웃</button>
                </div>
                <div id="admin-dashboard" class="admin-grid">
                    <!-- 사용자 카드들이 여기에 렌더링됨 -->
                </div>
            </div>
        </main>
    </div>

    <script type="module" src="index.js"></script>
    <script>
    const SUITABILITY_DATA = [
        { id: "tech", title: "1. 기술 역량", items: [{ id: "t1", text: "새로운 기술을 배우고 문제를 해결하는 데 흥미를 느낀다." }, { id: "t2", text: "최신 기술 및 업계 동향을 지속적으로 학습하고 있다." }, { id: "t3", text: "RFP, 제안서, PoC 보고서 등의 문서를 작성하는 것이 익숙하다." }] },
        { id: "biz", title: "2. 비즈니스 및 고객 대응", items: [{ id: "b1", text: "고객이 원하는 가치를 이해하고, 비즈니스적 관점에서 솔루션을 고민할 수 있다." }, { id: "b2", text: "기업의 성장을 위해 좋은 제품을 만드는 것만큼 판매가 중요하다고 생각한다." }, { id: "b3", text: "고객이 명확하게 정의하지 않은 요구사항을 파악하고, 최적의 솔루션을 제안할 수 있다." }, { id: "b4", text: "고객과 신뢰를 구축하며, 협업을 원활하게 진행할 수 있다." }] },
        { id: "comm", title: "3. 커뮤니케이션 및 협업", items: [{ id: "c1", text: "기술적 내용을 고객이 이해하기 쉽게 설명할 수 있다." }, { id: "c2", text: "영업, 개발, 컨설팅 등 다양한 팀과 협업한 경험이 있다." }] },
        { id: "prob", title: "4. 문제 해결 및 멀티태스킹", items: [{ id: "p1", text: "복잡한 문제를 논리적으로 분석하고 해결책을 찾는 능력이 있다." }, { id: "p2", text: "여러 개의 프로젝트나 고객을 동시에 관리하고 진행할 수 있다." }] }
    ];

    const COMPETENCY_DATA = [
        { id: "d1", name: "1. 기술적 지식", weight: 5, items: [{ id: "c1_1", text: "제품 이해도", importance: 5 }, { id: "c1_2", text: "기능 숙지", importance: 5 }, { id: "c1_3", text: "경쟁사 분석", importance: 4 }, { id: "c1_4", text: "가치 제안", importance: 5 }] },
        { id: "d2", name: "2. 커뮤니케이션", weight: 5, items: [{ id: "c2_1", text: "효과적 대화", importance: 5 }, { id: "c2_2", text: "PT 기술", importance: 4 }, { id: "c2_3", text: "청중 이해", importance: 4 }, { id: "c2_4", text: "비기술적 설명", importance: 3 }] },
        { id: "d3", name: "3. 분석 및 문제해결", weight: 4.5, items: [{ id: "c3_1", text: "요구분석", importance: 5 }, { id: "c3_2", text: "문제해결", importance: 4 }, { id: "c3_3", text: "비즈니스 파악", importance: 4 }, { id: "c3_4", text: "해결책 제시", importance: 4 }] },
        { id: "d4", name: "4. 고객 관계", weight: 4, items: [{ id: "c4_1", text: "관계 형성", importance: 5 }, { id: "c4_2", text: "신뢰 구축", importance: 5 }, { id: "c4_3", text: "욕구 파악", importance: 4 }, { id: "c4_4", text: "관계 유지", importance: 3 }] },
        { id: "d5", name: "5. 기술 전략", weight: 4, items: [{ id: "c5_1", text: "환경 이해", importance: 5 }, { id: "c5_2", text: "모델 분석", importance: 4 }, { id: "c5_3", text: "실행 전략", importance: 5 }, { id: "c5_4", text: "가치 창출", importance: 4 }] }
    ];

    const app = {
        state: {
            userName: '',
            isAdmin: false,
            suitabilityScores: {},
            competencyScores: {}
        },

        submitName: async function() {
            const input = document.getElementById('user-name-input');
            const name = input.value.trim();
            if (!name) return;

            if (name === '관리자') {
                this.state.isAdmin = true;
                this.state.userName = '관리자';
                await this.initAdminDashboard();
                return;
            }

            this.state.isAdmin = false;
            const userData = await window.firebaseDB.loadUserData(name);
            this.state.userName = name;
            this.state.suitabilityScores = userData ? { ...userData.suitabilityScores } : {};
            this.state.competencyScores = userData ? { ...userData.competencyScores } : {};
            
            document.getElementById('user-name-display').innerText = `${name}님`;
            this.renderSuitabilityChecklist();
            this.renderCompetencyTable();
            document.getElementById('view-onboarding').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            this.navigate('suitability');
        },

        initAdminDashboard: async function() {
            document.getElementById('view-onboarding').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('app').classList.add('admin-mode');
            document.getElementById('sidebar').classList.add('hidden');
            this.navigate('admin');

            const dashboard = document.getElementById('admin-dashboard');
            dashboard.innerHTML = '<p>데이터를 불러오는 중입니다...</p>';
            
            const users = await window.firebaseDB.fetchAllUsers();
            this.renderAdminCards(users);
        },

        renderAdminCards: function(users) {
            const dashboard = document.getElementById('admin-dashboard');
            if (users.length === 0) {
                dashboard.innerHTML = '<p>저장된 사용자 데이터가 없습니다.</p>';
                return;
            }

            dashboard.innerHTML = users.map(user => {
                // 적합성 점수 계산
                const sValues = Object.values(user.suitabilityScores || {});
                const sSum = sValues.reduce((a, b) => a + b, 0);
                const sScore = Math.round((sSum / (11 * 5)) * 100);

                // 역량 영역별 점수 계산
                const compStatus = COMPETENCY_DATA.map(d => {
                    let sum = 0; let count = 0;
                    d.items.forEach(i => {
                        if (user.competencyScores && user.competencyScores[i.id]) {
                            sum += user.competencyScores[i.id];
                            count++;
                        }
                    });
                    const pct = count === 0 ? 0 : Math.round((sum / (d.items.length * 5)) * 100);
                    return { name: d.name.split('. ')[1], pct };
                });

                // 우선순위 Top 3 (동일 로직)
                const prios = [];
                COMPETENCY_DATA.forEach(d => d.items.forEach(i => {
                    const s = (user.competencyScores || {})[i.id];
                    if(s) {
                        const g = d.weight * i.importance * (i.importance - s);
                        if(g > 0) prios.push({ text: i.text, gap: g });
                    }
                }));
                prios.sort((a,b) => b.gap - a.gap);
                const topPrios = prios.slice(0, 3);

                return `
                    <div class="admin-user-card">
                        <div class="admin-card-header">
                            <div>
                                <h3 class="admin-user-name">${user.userName || user.id}</h3>
                                <div class="admin-update-time">최종 업데이트: ${user.updatedAt ? new Date(user.updatedAt).toLocaleDateString() : '정보 없음'}</div>
                            </div>
                            <div class="admin-score-badge">${sScore}점</div>
                        </div>
                        
                        <div class="admin-section-label">업무 적합성 분석</div>
                        <div style="font-size:12px; color:var(--text-secondary); margin-bottom:12px;">전체 진단 항목 중 ${sValues.length}/11 항목 완료</div>

                        <div class="admin-section-label">역량 달성도 분석</div>
                        ${compStatus.map(c => `
                            <div class="admin-comp-row"><span>${c.name}</span><span>${c.pct}%</span></div>
                            <div class="admin-comp-bar"><div class="admin-comp-fill" style="width:${c.pct}%"></div></div>
                        `).join('')}

                        <div class="admin-section-label">중점 학습 우선순위</div>
                        <div style="margin-top:8px;">
                            ${topPrios.length > 0 ? topPrios.map(p => `<span class="admin-priority-tag">${p.text}</span>`).join('') : '<span style="font-size:11px; color:var(--text-muted)">데이터 부족</span>'}
                        </div>
                    </div>
                `;
            }).join('');
        },

        navigate: function(viewName) {
            const views = ['suitability', 'competency', 'report', 'admin'];
            views.forEach(v => {
                const el = document.getElementById(`view-${v}`);
                if (el) el.classList.add('hidden');
                const menu = document.getElementById(`menu-${v}`);
                if (menu) menu.classList.remove('active');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            const activeMenu = document.getElementById(`menu-${viewName}`);
            if (activeMenu) activeMenu.classList.add('active');
        },

        // --- 기타 UI 렌더링 함수들 (기존 기능 유지) ---
        renderSuitabilityChecklist: function() {
            const container = document.getElementById('checklist-container');
            container.innerHTML = SUITABILITY_DATA.map(cat => `
                <div class="card-premium" style="padding:24px;">
                    <h2 style="font-size:16px; margin-bottom:16px;">${cat.title}</h2>
                    ${cat.items.map(item => `<div style="padding:12px 0; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between;"><span>${item.text}</span><span>[${this.state.suitabilityScores[item.id] || '-'}]</span></div>`).join('')}
                </div>
            `).join('');
        },
        renderCompetencyTable: function() {
            const container = document.getElementById('competency-table-container');
            container.innerHTML = '<div style="padding:40px; text-align:center;">역량 평가 테이블은 사용자 진단 모드에서 활성화됩니다.</div>';
        },
        resetSuitability: function() { alert('기능 준비 중입니다.'); },
        resetCompetency: function() { alert('기능 준비 중입니다.'); },
        downloadPDF: function() { alert('PDF 생성은 사용자 리포트 화면에서 가능합니다.'); }
    };

    window.app = app;
    </script>
</body>
</html>
